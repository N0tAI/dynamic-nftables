#!/bin/bash
declare -A unique_rules

scan_dir() {
    local dir="$1"
    [ -d "$dir" ] || return

    shopt -s nullglob
    
    for file in "$dir"/*.nft; do
        # Key = filename
        # Value = full path
        unique_rules["$(basename "$file")"]="$file"
    done
    
    shopt -u nullglob
}

scan_dir "/usr/lib/nftables/static"
scan_dir "/etc/nftables/static"
scan_dir "/run/nftables/static"

echo "#!/usr/bin/nft -f"
echo "# AUTOMATICALLY GENERATED by gen-nftable - DO NOT EDIT DIRECTLY"
echo "flush ruleset"

# Output includes sorted by filename to ensure 00- comes before 99-
for name in $(printf '%s\n' "${!unique_rules[@]}" | sort); do
    echo "include \"${unique_rules[$name]}\""
done
