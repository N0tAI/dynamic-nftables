#!/bin/bash
declare -A unique_rules

scan_dir() {
    local dir="$1"
    [ -d "$dir" ] || return

    shopt -s nullglob
    
    for file in "$dir"/*.nft; do
        # Key = filename
        # Value = full path
        unique_rules["$(basename "$file")"]="$file"
    done
    
    shopt -u nullglob
}

scan_dir "/usr/lib/nftables/static"
scan_dir "/etc/nftables/static"
scan_dir "/run/nftables/static"

cat <<EOF
#!/usr/bin/nft -f
# AUTOMATICALLY GENERATED by gen-nftable - DO NOT EDIT DIRECTLY
flush ruleset

table inet global {
    chain dynamic_input {
        # container for dynamic rules
    }
    chain dynamic_output {
        # container for dynamic rules
    }
    chain dynamic_forward {
        # container for dynamic rules
    }
    chain input {
        type filter hook input priority 0; policy accept;
    }
    chain output {
        type filter hook output priority 0; policy accept;
    }
    chain forward {
        type filter hook forward priority 0; policy drop;
    }
}
EOF

# Output includes sorted by filename to ensure 00- comes before 99-
for name in $(printf '%s\n' "${!unique_rules[@]}" | sort); do
    echo "include \"${unique_rules[$name]}\""
done
